<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! src/main/resources/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011-2013 ForgeRock, Inc.
  !    
-->
<appendix xml:id='appendix-best-practices'
 xmlns='http://docbook.org/ns/docbook'
 version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Best Practices for Upgrading Your OpenAM Deployment</title>

 <para>This appendix covers best practices for upgrading OpenAM. Before you 
 begin the upgrade process, it is a good idea to review best practices because odds 
 are it has been a while since your last upgrade. This makes it too easy to forget 
 important steps that could save you either having to rerun the upgrade process or lose 
 data because you did not backup your deployment.</para> 
 
  <section xml:id="Backing-up">
   <title>Backing Up the Current Deployment</title>
   <indexterm><primary>Back up</primary></indexterm>
    <para>This section talks about the best practices for backing up your OpenAM
    Deployments.</para>
   <procedure xml:id="backup-procedure">
    <step>
     <para>Stop the container.</para>
    </step>
    <step>
     <para>If you have OpenDJ installed, stop it.</para>
    </step>
    <step>
     <para>Backup the file system directory for the current deployment.</para>
     <screen>$ tar -xvzf path/to/tomcat
$ tar -xvzf path/to/openam_home
$ tar -xvzf path/to/opendj
$ tar -xvzf ~/.openssocfg</screen>
    </step>

    <step>
     <para>Copy the OpenAM home directory.</para>
     <screen>$ cp $HOME/openam /path/to/backup-area</screen>
    </step>

    <step>
     <para>Copy the OpenAM <filename>.war</filename> file.</para>
     <note>
      <para>If you use this method, it will be more difficult to read your old
      configuration. Should you start the older version of OpenDJ the information will
      be in binary instead of the expected LDIF export format. If this is a potential
      problem, you can use <command>export-svc-cfg</command> instead.</para>
     </note>
    </step>
   </procedure>

  </section>
 
 <section xml:id="custumize">
  <title>Handling Customization</title>
   <indexterm><primary>Customize</primary></indexterm>
 
   <para>Most deployments use customized OpenAM end user pages to make them appear
   consistent with the webpages they protect. This section provides instructions to
   help update your existing customized files to a new version.</para>
   
   <itemizedlist>
    <para>Consider the following recommendations before beginning customizing the 
    OpenAM <filename>.war</filename> file.</para>
   
     <listitem>
      <para>Make sure to track the changes you make to make it easier to apply the
      changes with each upgrade.</para>
     </listitem>

     <listitem>
      <para>All changes should be made before you deploy the <filename>.war</filename> 
      file. After you have deployed the web application, do not change the content 
      of the <filename>.war</filename> file in a servlet container.</para>
     </listitem>

     <listitem>
      <para>If possible, automate the build process.</para>
     </listitem>
    </itemizedlist>
   
   <procedure xml:id="update-custom">
    <title>To Customize an OpenAM Deployment</title>

    <step>
     <para>Create a new directory and expand your current <filename>.war</filename> file
     so that you can copy your customized files.</para>
    </step>
    <step>
     <para>Download your upgrade file from <link 
     xlink:show="new" xlink:href="http://forgerock.com/openam-downloads/"
     ><citetitle>Enterprise Downloads page</citetitle></link> or from the <link 
     xlink:show="new" xlink:href="http://forgerock.org/openam-archive.html"
     ><citetitle>Archives page</citetitle></link>.</para>
    </step>
    <step>
     <para>Create a second new directory near your customized expanded 
     <filename>.war</filename> and expand the update <filename>.war</filename> file.</para>
    </step>
    <step>
     <para>Copy your customized files from your expanded <filename>.war</filename> 
     file and replace those files in the expanded update <filename>.war</filename> file.</para>
    </step>
    <step>
     <para>Rebuild the <filename>.war</filename> file.</para>
    </step>
 
   </procedure>

   <example xml:id="custom-example">
   <?dbfo keep-together="auto"?>
    <title>Applying Customizations to a New OpenAM Server</title>
    <para>The following example updates OpenAM 10.0.0 to <?eval ${serverDocTargetVersion}?>  
    on a Linux instance.</para>
  
    <orderedlist numeration="arabic">
    <listitem>
     <para>Create a new directory and expand your current <filename>.war</filename>.</para>
     <screen>$ cd /path/above/openam
$ mkdir expanded-openam-war ; cd expanded-openam-war
$ mkdir current-war ; cd current-war
$ jar xvf /path/to/tomcat/webapps/openam.war</screen>
    </listitem>

    <listitem>
     <para>Download your upgrade file or files from <link 
     xlink:show="new" xlink:href="http://forgerock.com/openam-downloads/"
     ><citetitle>Enterprise Downloads page</citetitle></link> or from the <link 
     xlink:show="new" xlink:href="http://forgerock.org/openam-archive.html"
     ><citetitle>Archives page</citetitle></link>.</para>
    </listitem>

    <listitem>
     <para>Create a new directory to expand the <filename>.war</filename> file.</para>
     <screen>$ cd /path/to/expanded-openam-war
$ mkdir update-war ; cd update-war
$ jar xvf ~/Downloads/<?eval ${coreWarFile}?></screen>
    </listitem>

    <listitem>
     <para>Add your customized content to the web app content.</para>
    </listitem>

    <listitem>
     <para>Rebuild the updated <filename>.war</filename> file</para>
     <screen>$ jar cvf openam.war *</screen>
    </listitem>

   </orderedlist>

   </example>
  </section>

 <section xml:id="restore">
  <title>Restoring a Previous Deployment</title>
  <indexterm><primary>Restore</primary></indexterm>
   <para>This section shows you how to revert OpenAM core services and policy agents, 
   and provides examples for each.</para>

   <para>This section uses the Apache Tomcat container on a Linux instance 
   and the Apache 2.2 policy agent in the examples.</para>

   <procedure xml:id="revert-from-upgrade">
    <title>To Revert To An Earlier OpenAM Version</title>
  
    <para>The quickest way to revert to an earlier deployment is to restore all 
    of the files from your previous deployment. You also must return to an earlier 
    version of the configuration store data.</para>

    <step>
     <para>Stop the server or servers.</para>
    </step>
    <step>
     <para>Remove the OpenAM home directory.</para>
    </step>
    <step>
     <para>Reinstall the original directory server if you changed the configuration
     store.</para>
    </step>
    <step>
     <para>Unzip the backup</para>
    </step>
    <step>
     <para>Restart the servers.</para>
    </step>
   </procedure>

    <procedure xml:id="revert-same-major-version-agent">
    <title>To Revert Version 3 Policy Agents</title>
    
     <note>
      <para>When reverting a Java EE agent, it is safer to uninstall the policy agent and 
      reinstall the old agent. This replaces several pieces of the agent, such as
      .jars for the classpath.</para>
    </note>

    <step>
     <para>Review the Release Notes to make sure your policy agent configuration
     does not set parameters not supported by the earlier version. If you use parameters 
     that appear in this section of Release Notes posted since the deployment you 
     are working to restore, you will need to remove the parameter before you 
     attempt to revert the policy agent. If you skip versions, you could miss some 
     of the parameters and will need to review all Release Notes for all intervening 
     versions.</para>
    </step>
    <step>
     <para>Stop your web server, web container, as applicable.</para>
    </step>
    <step>
     <para>Restore the file system directory for the policy agent with the earlier
     version you backed up.</para>
    </step>
    <step>
     <para>Restart the web server, web container, or policy agent.</para>
    </step>

   </procedure>

    <example xml:id="revert-agent-example">
    <title>Restoring Apache 2.2 Example</title>

    <para>The following example demonstrates how to revert the Apache 2.2
    policy agent, version 3.0.4 back to Apache 2.2, version 3.0.3.</para>

   <orderedlist numeration="arabic">
    <listitem>
     <para>The <link xlink:href="https://wikis.forgerock.org/confluence/display/openam/OpenAM+Web+Policy+Agents+3.0.4+Release+Notes">
     <citetitle>Release Notes</citetitle></link> show that a new custom parameter
     (<literal>com.forgerock.agents.config.notenforced.ip.handler=cidr</literal>)
     has been added since version 3.0.3. If you have this parameter set, you 
     will lose it when returning to the earlier version of the policy agent.</para>
    </listitem>

    <listitem>
     <para>Shutdown Tomcat.</para>
     <screen>$ cd /path/to/tomcat
$ ./bin/shutdown.sh</screen>
    </listitem>

    <listitem>
     <para>Stop Apache.</para>
     <screen>$ sudo /path/to/init.d/apache2 stop</screen>
    </listitem>

    <listitem>
     <para>Restore the file system directory for the policy agent with the earlier
     version you backed up.</para>
     <screen>$ cp /path/to/backup/web_agents /path/to/web_agents</screen>
    </listitem>

     <listitem>
      <para>Restart Apache.</para>

      <screen>$ sudo /path/to/init.d/apache2 start</screen>
     </listitem>
  
     <listitem>
      <para>Restart Tomcat.</para>
    
      <screen>$ cd /path/to/tomcat
$ ./bin/startup.sh</screen>
     </listitem>
    </orderedlist>

   </example>
  </section>

</appendix>