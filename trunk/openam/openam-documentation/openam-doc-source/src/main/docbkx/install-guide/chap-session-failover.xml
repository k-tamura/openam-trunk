<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! src/main/resources/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011-2013 ForgeRock, Inc.
  !    
-->
<chapter xml:id='chap-session-failover'
 xmlns='http://docbook.org/ns/docbook'
 version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Setting Up OpenAM Session Failover</title>
 <indexterm>
  <primary>Installing</primary>
  <secondary>Session failover</secondary>
 </indexterm>
 <indexterm>
  <primary>Installing</primary>
  <secondary>Load Balancer</secondary>
 </indexterm>
 <para>This chapter covers setting up session failover (SFO) when using multiple
 instances of OpenAM in a site configuration for high availability. The basic
 idea followed here is that you configure load balancing to be sticky, based
 on the value of an OpenAM cookie, <literal>amlbcookie</literal>, different
 for each OpenAM server. Should that server become unavailable, the load
 balancer fails client requests over to another OpenAM server. The other OpenAM
 server must then fail over the user session associated with the client.</para>
 
 <para>SFO relies on a highly available Core Token Service (CTS) to store OpenAM
 session data. The services is shared with other OpenAM servers. When the
 OpenAM server where a user authenticated goes down, other OpenAM servers can
 read the user session information from the CTS, so the user does not have to
 authenticate again. When the original OpenAM server becomes available again,
 it can also read session information from the CTS, and can carry on serving
 users with active sessions.</para>

 <important>
  <para>After upgrading from versions earlier than OpenAM 11.0.0, all users
  must login again as the OpenAM session representation has changed.</para>
 </important>

 <para><link xlink:href="install-guide#additional-instance-config"
     xlink:role="http://docbook.org/xlink/role/olink"><citetitle>
     Configuring an Additional Instance</citetitle></link>
     provides the steps to configure each instance of OpenAM.
     The following procedure describes how to configure an OpenAM
     server to use a load balancer for the first instance if it was not
     part of the initial configuration.</para>

 <procedure xml:id="first-instance-load-balancer">
  <title>Configure First OpenAM Instance Behind a Load Balancer</title>
  
  <para>Before you set up SFO, first configure OpenAM in a site
  configuration with a load balancer as the entry point to the site. The most 
  expedient way to configure the site is to set it up during the initial OpenAM
  configuration, where OpenAM can manage and replicate server configuration for 
  availability. However, you may already have a working instance before realizing that 
  multiple instances are necessary. The following steps walk you through setting
  up the load balancer for the first instance.</para>
  
  <step>
   <para>In the OpenAM console for the first instance of the site, select
   <literal> Configuration &gt; Servers and Sites</literal> and click on
   the first server under <literal>Servers</literal>.</para>
  </step>
  <step>
   <para>Under site <literal>Site</literal> click on <literal>Parent 
   Site</literal> and select the load balancer.</para>
  </step>
  <step>
   <para>Click on <literal>Save</literal>.</para>
  </step>
 </procedure>

 <procedure xml:id="before-you-start-site-failover">
  <title>Setting a Load Balancer on Existing Configurations</title>
  
  <para>If you did not set up the site during initial configuration,
  then follow all the steps below.</para>
  
  <step>
   <para>In the OpenAM console for one of the servers in the site, select
   Configuration &gt; Servers and Sites &gt; Sites &gt; New..., and then
   create a new site.</para>
   <para>The site URL is the URL to the load balancer in front of your OpenAM
   servers in the site. For example, if your load balancer listens on host
   <literal>lb.example.com</literal> and port <literal>8080</literal>,
   with OpenAM under <literal>/openam</literal>, then your site URL is
   <literal>http://lb.example.com:8080/openam</literal>.</para>
  </step>
  <step>
   <para>For each OpenAM server in the site, select Configuration &gt;
   Servers and Sites &gt; Servers &gt; <replaceable>Server Name</replaceable>,
   and then set Parent Site to the site you created before saving your
   work.</para>
  </step>
  <step performance="optional">
   <para>If you want to use sticky load balancing, configure your load balancer
   to inspect the value of the <literal>amlbcookie</literal> to determine which
   OpenAM server should receive the client request.</para>
   <para>As your load balancer depends on the <literal>amlbcookie</literal>
   value, on each OpenAM server console in the site, select Configuration &gt;
   Servers and Sites &gt; Servers &gt; <replaceable>Server Name</replaceable>
   &gt; Advanced, makes sure that
   <literal>com.iplanet.am.lbcookie.value</literal> is unique. By default
   the value of the <literal>amlbcookie</literal> is set to the server ID
   for the OpenAM instance.</para>
   <note>
    <para>When using SSL, the approach requires that you either terminate SSL
    on the load balancer, or that you re-encrypt traffic from the load balancer
    to the OpenAM servers.</para>
   </note>
   <para>If you must change <literal>amlbcookie</literal> values to make them
   unique, then your changes take effect after you restart the OpenAM server.
   (To check, login to the console and check the cookie value in your
   browser.)</para>
  </step>
  <step>
   <para>Restart each OpenAM server or the web containers where the OpenAM
   servers run so that all configuration changes take effect.</para>
  </step>
 </procedure>
 
 <procedure>
  <title>Configuring Session Failover after Installation</title>
  
  <para>Enabling session failover in  OpenAM requires a site configuration with one or
  more servers and OpenDJ as a configuration store (embedded or external). If these are 
  not setup before you begin the process, the New... button will be greyed out.</para>
    
  <para>The following steps walk you through configuring an additional instance.</para>
  <step> 
   <para>In the OpenAM console for one of the servers in the site, select
   Configuration &gt; Global &gt; Session &gt; and New... for the Secondary 
   Configuration Instance.</para>
  </step>
  <step>
   <para>Verify that the additional instance appears in the Name text box and that
   Session Persistence and High Availability Failover Enabled is checked.</para>
  </step>
  <step>
   <para>Save your changes.</para>
  </step>
 </procedure>
</chapter>
