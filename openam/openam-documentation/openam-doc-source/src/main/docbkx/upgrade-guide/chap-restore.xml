<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! src/main/resources/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011-2013 ForgeRock, Inc.
  !    
-->
<chapter xml:id='chap-restore'
 xmlns='http://docbook.org/ns/docbook'
 version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Restoring a Deployment</title>
 <indexterm><primary>Restore</primary></indexterm>
 <para>This chapter shows you how to revert OpenAM core services and policy agents, 
 and provides examples for each.</para>

 <para>This chapter uses the Apache Tomcat container on Ubuntu and the
 Apache 2.2 policy agent in the examples. <!-- TO DO If you use a different web application 
 container or policy agent for OpenAM, the <citetitle>Deployment Guide</citetitle> 
 provides more details for your environment.--></para>
 
 <procedure xml:id="revert-from-upgrade">
  <title>To Revert To An Earlier OpenAM Version</title>
  
  <para>The quickest way to revert to an earlier deployment is to restore all 
  of the files from your previous deployment. You also must return to an earlier 
  version of the configuration store data.</para>

  <step>
   <para>Verify that the JAVA_HOME is properly set.</para>
  </step>

  <step>
   <para>Stop OpenAM, or if necessary to redeploy OpenAM, stop the container 
   where OpenAM is running.</para>
  </step>
  <step>
   <para>Restore the old version of OpenAM files, including the 
   <filename>.war</filename> and the configuration directory.</para>
  </step>
  <step>
   <para>If your container caches OpenAM files, clear out the cache.</para>
  </step>
  <step>
   <para>Restore the earlier version of the configuration store data.</para>
   
   <para><literal>What happens if your configuration data was replicated?</literal></para>
  </step>
  <step>
   <para>Start the earlier version of OpenAM or the container where OpenAM
   runs.</para>
  </step>
 </procedure>
 
 <example xml:id="revert-from-upgrade-example">
 <?dbfo keep-together="auto"?>
 <title>Restoring An Earlier Tomcat Deployment Example</title>
 <para>The following example restores OpenAM using Tomcat on an Ubuntu 
 instance.</para>

  <orderedlist numberation="arabic">
   <listitem>
    <para>Verify that the JAVA_HOME is properly set.</para>
    <screen>echo $JAVA_HOME
 /path/to/java-6-sun</screen>
   </listitem>
   <listitem>
    <para>Shutdown Tomcat.</para>
    <screen>$ cd /path/to/tomcat
$ ./bin/shutdown.sh</screen>
   </listitem>
  
   <listitem>
    <para>Copy the backed up copy of your previous deployment of OpenAM files.</para>
    <screen>cp -r /path/to/backup/openam /path/to/tomcat/webapps/openam</screen>
   </listitem>
  
   <listitem>
    <para>Restore the earlier version of the configuration store data.</para>
    <screen>$ cp -r /path/to/backup/datastore ~/openam/opends</screen>
   </listitem>
  
   <listitem>
    <para>Remove files from the working directory where Tomcat has stored JSP files 
    from the upgraded version.</para>
    <screen>$ rm -fr /path/to/tomcat/work/Catalina/localhost/openam</screen>
    <para>If you skip this step, you can see an error like the following when
    logging into the console after reverting to the older version.</para>
    <screen>amConsole:10/29/2011 05:42:51:812 PM BST: Thread[http-8080-3,5,main]
ERROR: ConsoleServletBase.onUncaughtException
javax.servlet.ServletException: java.lang.NoClassDefFoundError:
 org/forgerock/openam/console/ui/taglib/header/CCHtmlHeaderTag
        at org.apache.jasper.runtime.PageContextImpl.doHandlePageException
         (PageContextImpl.java:862)
        at org.apache.jasper.runtime.PageContextImpl.handlePageException
         (PageContextImpl.java:791)
        at org.apache.jsp.console.task.Home_jsp._jspService(Home_jsp.java:564)
        at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)</screen>
   </listitem>
  
   <listitem>
    <para>Restart Tomcat.</para>
     <screen>$ cd /path/to/tomcat
$ ./bin/startup.sh</screen>
   </listitem>
  </orderedlist>
 </example>

  <procedure xml:id="revert-same-major-version-agent">
  <title>To Revert Version 3 Policy Agents</title>

  <step>
   <para>Review the Release Notes to make sure your policy agent configuration
   does not set parameters not supported by the earlier version. Release Notes 
   are available on the <link xlink:href="http://forgerock.org/openam.html">
   <citetitle>OpenAM Downloads page</citetitle></link>. The What's New Section 
   provides information on additions, like new parameters. If you use parameters 
   that appear in this section of Release Notes posted since the deployment you 
   are working to restore, you will need to remove the parameter before you 
   attempt to revert the policy agent. If you skip versions, you could miss some 
   of the parameters and will need to review all Release Notes for all intervening 
   versions.</para>
  </step>
  <step>
   <para>Verify that the JAVA_HOME is properly set.</para>
  </step>
  <step>
   <para>Stop your web server, web container, or policy agent, as applicable.</para>
  </step>
  <step>
   <para>When reverting a Java EE agent, stop the policy agent and affected
   applications, and revert the policy agent to the earlier version.</para>
  </step>
  <step>
   <para>Restore the file system directory for the policy agent with the earlier
   version you backed up.</para>
  </step>
  <step>
   <para>Restart the web server, web container, or policy agent.</para>
  </step>

 </procedure>

  <example xml:id="revert-agent-example">
  <title>Restoring Apache 2.2 Example</title>

  <para>The following example demonstrates how to revert the Apache 2.2
  policy agent, version 3.0.4 back to Apache 2.2, version 3.0.3.</para>

  <orderedlist numberation="arabic">
  <listitem>
   <para>Verify that the JAVA_HOME is properly set.</para>
   <screen>echo $JAVA_HOME
 /path/to/java-6-sun</screen>
  </listitem>

  <listitem>
   <para>The <link xlink:href="https://wikis.forgerock.org/confluence/display/openam/OpenAM+Web+Policy+Agents+3.0.4+Release+Notes">
   <citetitle>Release Notes</citetitle></link> show that a new custom parameter
   (<literal>com.forgerock.agents.config.notenforced.ip.handler=cidr</literal>)
   has been added since version 3.0.3. If you have this parameter set, you 
   will lose it when returning to the earlier version of the policy agent.</para>
  </listitem>

  <listitem>
   <para>Shutdown Tomcat.</para>
   <screen>$ cd /path/to/tomcat
$ ./bin/shutdown.sh</screen>
  </listitem>

  <listitem>
   <para>Stop Apache.</para>
   <screen>$ sudo /path/to/init.d/apache2 stop</screen>
  </listitem>

  <listitem>
   <para>Restore the file system directory for the policy agent with the earlier
   version you backed up.</para>
   <screen>$ cp /path/to/backup/web_agents /path/to/web_agents</screen>
  </listitem>

   <listitem>
    <para>Restart Apache.</para>

    <screen>$ sudo /path/to/init.d/apache2 start</screen>
   </listitem>
  
   <listitem>
    <para>Restart Tomcat.</para>
    
    <screen>$ cd /path/to/tomcat
$ ./bin/startup.sh</screen>
   </listitem>
  </orderedlist>

 </example>

<!-- TODO: Placeholder if we choose to describe upgrade from earlier versions.
 <procedure xml:id="upgrade-earlier-major-version">
  <title>To Upgrade Version 2 Agents</title>

  <para>Follow these steps to upgrade a version 2 policy agent to
  version 3.</para>

  <step>
   <para>TODO</para>
  </step>
 </procedure> -->

</chapter>
