<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! src/main/resources/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011-2013 ForgeRock, Inc.
  !    
-->
<chapter xml:id='chap-legacy'
 xmlns='http://docbook.org/ns/docbook'
 version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'
 xmlns:xinclude='http://www.w3.org/2001/XInclude'>
 <title>Upgrading Legacy OpenAM Deployments</title>
 <indexterm><primary>Legacy</primary></indexterm>

 <para>This chapter shows you how to upgrade OpenAM core services from OpenAM 9.0.x
 or earlier to a more current release. The following procedure includes some example 
 instructions for a Tomcat instance. Port numbers and directory names may be 
 different for your deployment.</para>

 <note>
  <para>For complex legacy deployments, ForgeRock can assist you through the 
  upgrade process. Send mail to <link xlink:href="mailto:info@forgerock.com"
  >info@forgerock.com</link> for more information.</para>
 </note>
 
 <procedure xml:id="upgrade-legacy">
  <title>To Upgrade A Legacy Deployment</title>
    
   <step>
    <para>Verify that the JAVA_HOME is properly set.</para>
    <screen>echo $JAVA_HOME
 /path/to/java-6-sun</screen>
   </step>

   <step>
    <para><link xlink:href="upgrade-guide#chap-custom"
      xlink:role="http://docbook.org/xlink/role/olink">
      <citetitle>Customize</citetitle></link> your deployment if desired.</para>
   </step>

   <step>
    <para>Export your OpenAM configuration data.</para>
    <para>If you have multiple instances, make sure all instances are running 
    before you begin. This is a requirement to export multiple instances.</para>
    <screen>$ cd /path/to/ssoadm-home/openam/bin
$ ./ssoadm export-svc-cfg --adminid amadmin --password-file /path/to/password/file 
 --encryptsecret mySecretEncryptionKey --outfile openam-config-export.xml</screen>
   </step>
   
   <step>
    <para>Export configuration backbend or DN from the directory server
    if you have userRoot in OpenDS or OpenDJ. For embedded configuration stores, 
    this is typically <literal>~/openam/opends/bin</literal>.</para>
    <screen>$ cd ~/openam/opends/bin/
$ ./backup --port 4444 --binDN "cn=Directory Manager" --binPassword password 
 --backendID userRoot --backupDirectory /path/to/backup-directory --start 0</screen>
   </step>

   <step>
    <para>Copy the configuration directory.</para>
    <screen>$ tar -czvf openam-home.tar.gz ~/openam</screen>
   </step>

   <step>
    <para>Copy your expanded <filename>.war</filename> directory to include 
    any customized components within the web application.</para>
    <screen>$ jar -cvf openam-customized.war /path/to/expanded-war-directory</screen>
   </step>

   <step>
   <para>Stop OpenAM, or if necessary to redeploy OpenAM, stop the container 
   where OpenAM is running.</para>
   </step>

   <step>
    <para>Remove the old <filename>.war</filename> file.</para>
   </step>

   <step>
    <para>Clear your container caches, as applicable.</para>
   </step>

   <step>
    <para>Remove the OpenAM home directory. (<literal> What is the home directory? $HOME/ deployment-uri /, 
    e.g. ~/openam? </literal>)</para>
    <screen>$ rm -rf /path/to/openam-home-directory</screen>
   </step>

   <step>
    <para>Delete the root DN of the old configurations if you have an external
    OpenAM configuration store.</para>
    <screen>$ ./ldapdelete --hostName opendj.example.com --port 1389 
 --bindDN "cn=DirectoryManager" --bindPassword password
 --noPropertiesFile dc=opensso,dc=java,dc=net</screen>
   </step>

   <step>
    <para>Delete the OpenAM locator file from <literal>$ HOME/.openssocfg</literal>.</para>
   </step>

   <step>
    <para>Refer to the <link xlink:href="http://openam.forgerock.org/openam-documentation/openam-doc-source/doc/install-guide/index.html">
    <citetitle>Installation Guide</citetitle></link> for your new OpenAM instance
    to deploy the <filename>.war</filename> file, particularly if you have 
    multiple instances.</para>
   </step>

 </procedure>

</chapter>
