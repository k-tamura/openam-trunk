<?xml version="1.0" encoding="UTF-8"?>
<!--
  ! CCPL HEADER START
  !
  ! This work is licensed under the Creative Commons
  ! Attribution-NonCommercial-NoDerivs 3.0 Unported License.
  ! To view a copy of this license, visit
  ! http://creativecommons.org/licenses/by-nc-nd/3.0/
  ! or send a letter to Creative Commons, 444 Castro Street,
  ! Suite 900, Mountain View, California, 94041, USA.
  !
  ! You can also obtain a copy of the license at
  ! src/main/resources/legal-notices/CC-BY-NC-ND.txt.
  ! See the License for the specific language governing permissions
  ! and limitations under the License.
  !
  ! If applicable, add the following below this CCPL HEADER, with the fields
  ! enclosed by brackets "[]" replaced with your own identifying information:
  !      Portions Copyright [yyyy] [name of copyright owner]
  !
  ! CCPL HEADER END
  !
  !      Copyright 2011-2014 ForgeRock AS
  !    
-->
<chapter xml:id='chap-compatibility'
 xmlns='http://docbook.org/ns/docbook' version='5.0' xml:lang='en'
 xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
 xsi:schemaLocation='http://docbook.org/ns/docbook
                     http://docbook.org/xml/5.0/xsd/docbook.xsd'
 xmlns:xlink='http://www.w3.org/1999/xlink'>
 <title>OpenAM Changes &amp; Deprecated Functionality</title>

 <para>This chapter covers both major changes to existing functionality, and
 also deprecated and removed functionality.</para>

 <section xml:id="changes">
  <title>Important Changes to Existing Functionality</title>

  <itemizedlist>
   <listitem>
    <para>
     TODO: Finish updating before release
    </para>
   </listitem>

   <!-- Update docs for click-through license acceptance KEEP THIS AT TOP -->
   <listitem>
       <para>All OpenAM core server, tools, and agent installers now display a
        software license acceptance screen prior to configuration.
        You must agree to the license to continue the configuration. </para>
       <para>For users implementing scripted or silent installs, the installers
       and upgrader tools provide a <option>--acceptLicense</option> command-line
       option, indicating that you have read and accepted the terms of the
       license. If the option is not present on the command-line invocation,
       the installer or upgrader will interactively present a license agreement
       screen to the user.</para>
   </listitem>

   <listitem>
    <!-- AME-4013, AME-2766, etc. -->
    <para>
     When you visit the Policies tab for a realm in OpenAM console,
     OpenAM now directs you to the new policy editor.
     For instructions on using the new policy editor,
     see the <citetitle>Administration Guide</citetitle> chapter,
     <link
      xlink:href="admin-guide#chap-authz-policy"
      xlink:show="new"
      xlink:role="http://docbook.org/xlink/role/olink"
     ><citetitle>Defining Authorization Policies</citetitle></link>.
     Notice that policies now belong to applications
     as described in that chapter.
    </para>

    <itemizedlist>
     <para>
      OpenAM has changed its internal representation for policies
      to better fit the underlying implementation,
      which is based on the newer engine
      designed for higher performance and finer grained policies.
      When you upgrade to this version,
      OpenAM migrates your policies to the new representation.
     </para>

     <para>
      Depending on your existing policies before upgrade,
      you can see the following differences.
     </para>

     <listitem>
      <para>
       Existing policies with multiple resource rules
       map to multiple new policies.
      </para>

      <para>
       When a single policy maps to multiple policies during migration,
       OpenAM appends a number to the existing name for each new policy.
       This allows you to recognize the set of policies
       when you must manage them together,
       for example to change them all in the same way.
      </para>

      <para>
       This behavior is to optimize policy evaluation performance.
       The newer policy engine matches resources to policies during evaluation
       with indexing that proves very efficient
       as long as each policy specifies one resource pattern.
       OpenAM processes the list of resources in policies in linear fashion,
       so long lists of resources can slow policy evaluation.
      </para>
     </listitem>

     <listitem>
      <para>
       Conditions in existing policies map to newer representations.
      </para>

      <para>
       New representations exist for all existing conditions
       provided in OpenAM out of the box.
       Custom conditions developed for your deployment
       do not map to any of the newer conditions provided.
       In that case you must migrate your custom conditions,
       and then configure your policies to use them.
       <!-- Q: How to migrate custom conditions? A: Pending OPENAM-4015. -->
      </para>
     </listitem>

     <listitem>
      <para>
       When OpenAM encounters issues migrating policies during upgrade,
       it writes messages about the problems in the upgrade log.
       When you open a policy in the policy editor
       that caused problems during the upgrade process
       the policy editor shows the issues,
       but does not let you fix them directly.
       Instead you must create equivalent, corrected policies
       in order to use them in OpenAM.
      </para>
     </listitem>
    </itemizedlist>

    <itemizedlist>
     <para>
      OpenAM configuration has changed in several ways to accommodate
      the changes to the way policies are managed.
     </para>

     <listitem>
      <para>
       The policy service configuration has changed
       to simplify the Policy Configuration pages in OpenAM console.
       For details see the <citetitle>Reference</citetitle> section,
       <link
        xlink:href="reference#policy-configuration"
        xlink:show="new"
        xlink:role="http://docbook.org/xlink/role/olink"
       ><citetitle>Policy Configuration</citetitle></link>.
      </para>
     </listitem>

     <listitem>
      <para>
       OpenAM now requires policy referrals only when an application
       is administered across multiple realms,
       as can be the case when one policy agent protects multiple applications.
       Otherwise, OpenAM can use new settings in policy agent profiles
       to direct policy agent requests to the appropriate realm and application.
      </para>

      <para>
       The web and Java EE policy agent profiles includes the new settings
       under OpenAM Services > Policy Client Service in OpenAM console.
       These new settings allow you to set the realm and application
       for a policy agent.
       The settings are compatible with existing policy agents,
       as they are not used by the policy agents themselves,
       but instead by OpenAM when handling policy agent requests.
      </para>
     </listitem>
    </itemizedlist>

    <para>
     The fix for <link xlink:show="new"
     xlink:href="https://bugster.forgerock.org/jira/browse/OPENAM-3509"
     >OPENAM-3509</link> ensures that OpenAM considers a trailing slash
     as part of the resource name to match.
     This improves compatibility between self and subtree modes,
     and compatibility with older policy agents.
    </para>
   </listitem>

   <listitem>
    <para>
     Following a change to the SAML 2.0 pages in OpenAM,
     you no longer customize <filename>saml2login.template</filename>
     and <filename>saml2loginwithrelay.template</filename>
     to add a progress bar for single sign on.
     Instead, customize <filename>saml2/jsp/autosubmitaccessrights.jsp</filename>
     as described in the procedure,
     <link xlink:show="new" xlink:href="admin-guide#show-saml2-sso-login-progress"
     xlink:role="http://docbook.org/xlink/role/olink"><citetitle
     >To Indicate Progress During SSO</citetitle></link>.
    </para>
   </listitem>

   <listitem>
    <para>
     When running OpenAM on WebLogic 11g, you must add a WebLogic-specific
     descriptor file, <filename>WEB-INF/weblogic.xml</filename> in the .war
     before deployment.
    </para>
   </listitem>

   <listitem>
    <para>
     The class hierarchy for the <literal>ResourceName</literal> interfaces has
     changed. Previous implementations should be source-compatible, but will not
     be binary-compatible, and will need recompiling.
    </para>
   </listitem>
  </itemizedlist>
 </section>

 <section xml:id="deprecated">
  <title>Deprecated Functionality</title>
  
  <para>The following functionality is deprecated in OpenAM
  <?eval ${serverDocTargetVersion}?>, and is likely to be removed in a future
  release.</para>

  <itemizedlist>
   <listitem>
    <para>
     TODO: Update before release
    </para>
   </listitem>

   <!-- Are any of these deprecated features removed in OpenAM 12.0.0? -->
   <!-- START: Deprecated in OpenAM 11.0.0 -->
   <listitem>
    <para>With the implementation of OAuth 2.0 in this release, OAuth 1.0 has been 
    deprecated. OAuth 1.0 support was originally provided in OpenAM 9.</para>
   </listitem>

   <listitem>
    <para>The Netscape LDAP API is to be removed from OpenAM, with OpenAM
    using the OpenDJ LDAP SDK instead. This affects all classes in
    <literal>com.sun.identity.shared.ldap.*</literal> packages.</para>
   </listitem>

   <listitem>
    <para>OpenAM currently uses Sun Java System Application Framework (JATO).
    JATO is deprecated and is likely to be replaced in a future release.</para>
   </listitem>

   <listitem>
    <para>With the implementation of the Persistent Cookie authentication module, the
    Core Authentication module persistent cookie options are deprecated and are
    likely to be removed in a future release.</para>
   </listitem>
   <!-- END: Deprecated in OpenAM 11.0.0 -->

   <listitem>
    <para>
     The OAuth 2.0 plugin interface for custom scopes,
     <link
      xlink:href="${javadocBase}?org/forgerock/openam/oauth2/provider/Scope.html"
      xlink:show="new"><literal>Scope</literal></link>
     is deprecated and likely to be removed in a future release.
    </para>

    <para>
     Custom OAuth 2.0 scopes plugins now implement the
     <link
      xlink:href="${javadocBase}?org/forgerock/oauth2/core/ScopeValidator.html"
      xlink:show="new"
      ><literal>ScopeValidator</literal></link> interface instead.
     For an example, see the <citetitle>Developer's Guide</citetitle> chapter,
     <link
      xlink:href="dev-guide#chap-oauth2-scopes"
      xlink:role="http://docbook.org/xlink/role/olink"
      xlink:show="new"
      ><citetitle>Customizing OAuth 2.0 Scope Handling</citetitle></link>.
    </para>
   </listitem>

   <listitem>
    <para>
     The OAuth 2.0 plugin interface for custom response types,
     <link
      xlink:href="${javadocBase}?org/forgerock/openam/oauth2/provider/ResponseType.html"
      xlink:show="new"><literal>ResponseType</literal></link>
     is deprecated and likely to be removed in a future release.
    </para>

    <para>
     Custom OAuth 2.0 response type plugins now implement the
     <link
      xlink:href="${javadocBase}?org/forgerock/oauth2/core/ResponseTypeHandler.html"
      xlink:show="new"
      ><literal>ResponseTypeHandler</literal></link> interface instead.
    </para>
   </listitem>
  </itemizedlist>
 </section>

 <section xml:id="removed">
  <title>Removed Functionality</title>

  <itemizedlist>
   <listitem>
    <para>
     TODO: Finish updating before release
    </para>
   </listitem>
  </itemizedlist>
 </section>

 <section xml:id="rest-changes">
  <title>REST API Changes &amp; Deprecated Functionality</title>

  <para>This section covers changes to existing REST API
   functionality, and also deprecated and removed REST API functionality.</para>

  <para>OpenAM <?eval ${serverDocTargetVersion}?> contains the following
   changes to the REST API.</para>

  <itemizedlist>
   <listitem>
    <para>Changing Passwords</para>
    <para>Changing passwords by using a PUT REST API call is no longer
     supported.</para>
    <para>Use a POST request to
     <literal>/json/<replaceable>subrealm</replaceable
      >/users/<replaceable>username</replaceable>?_action=changePassword</literal>
     to change a password.</para>
   </listitem>

   <listitem>
    <para><literal>/json/authenticate</literal></para>
    <para>The response returned when submitting incorrect credentials has
     changed.</para>
    <table>
     <title>REST End Points</title>

     <tgroup cols="2">
      <colspec colnum="1" colwidth="1*"/>
      <colspec colnum="2" colwidth="1*"/>

      <thead>
       <row>
        <entry>OpenAM 11.0.1</entry>
        <entry>OpenAM 12.0.0</entry>
       </row>
      </thead>

      <tbody>
       <row>
        <entry>
<screen>
<computeroutput>{
 "errorMessage": "Authentication Failed!!",
 "failureUrl": "https://openam.example.com:8443"
}</computeroutput>
</screen>
        </entry>
        <entry>
<screen>
<computeroutput>{
 "code": 401,
 "reason": "Unauthorized",
 "message": "Authentication Failed!!",
 "detail": {
  "failureUrl": "https://openam.example.com:8443"
 }
}</computeroutput>
</screen>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </table>
   </listitem>

   <listitem>
    <para>Older REST services relying on the following end points are
     deprecated.</para>

    <simplelist type="vert" columns="2">
     <member>/identity/attributes</member>
     <member>/identity/authenticate</member>
     <member>/identity/authorize</member>
     <member>/identity/create</member>
     <member>/identity/delete</member>
     <member>/identity/isTokenValid</member>
     <!-- Pending replacement <member>/identity/log</member> -->
     <member>/identity/logout</member>
     <member>/identity/read</member>
     <member>/identity/search</member>
     <member>/identity/update</member>
     <member>/ws/1/entitlement/decision</member>
     <member>/ws/1/entitlement/decisions</member>
     <member>/ws/1/entitlement/entitlement</member>
     <member>/ws/1/entitlement/entitlements</member>
    </simplelist>

    <para>The following table shows how legacy and newer end points
     correspond.</para>

    <table>
     <title>REST End Points</title>

     <tgroup cols="2">
      <colspec colnum="1" colwidth="1*"/>
      <colspec colnum="2" colwidth="1*"/>

      <thead>
       <row>
        <entry><link xlink:show="new" xlink:href="admin-guide#interface-stability"
                     xlink:role="http://docbook.org/xlink/role/olink">Deprecated</link> URIs</entry>
        <entry>Newer <link xlink:show="new" xlink:href="admin-guide#interface-stability"
                           xlink:role="http://docbook.org/xlink/role/olink">Evolving</link> URIs</entry>
       </row>
      </thead>

      <tbody>
       <row>
        <entry>/identity/attributes</entry>
        <entry>/json/users</entry>
       </row>

       <row>
        <entry>N/A</entry>
        <entry>/json/applications</entry>
       </row>

       <row>
        <entry>N/A</entry>
        <entry>/json/applicationtypes</entry>
       </row>

       <row>
        <entry>/identity/authenticate</entry>
        <entry>/json/authenticate</entry>
       </row>

       <row>
        <entry>N/A</entry>
        <entry>/json/conditiontypes</entry>
       </row>

       <row>
        <entry>/identity/authorize</entry>
        <entry>/json/policies?_action=evaluate, /json/policies?_evaluateTree</entry>
       </row>

       <row>
        <entry>/identity/create, /identity/delete, /identity/read,
         /identity/search, /identity/update</entry>
        <entry>/json/agents, /json/groups, /json/realms, /json/users</entry>
       </row>

       <row>
        <entry>/identity/isTokenValid</entry>
        <entry>/json/sessions/<replaceable>tokenId</replaceable>?_action=validate</entry>
       </row>

       <!--
       <row>
        <entry>/identity/log</entry>
        <entry>Pending replacement</entry>
       </row>
       -->

       <row>
        <entry>/identity/logout</entry>
        <entry>/json/sessions/?_action=logout</entry>
       </row>

       <row>
        <entry>/ws/1/entitlement/decision, /ws/1/entitlement/decisions,
         /ws/1/entitlement/entitlement, /ws/1/entitlement/entitlements</entry>
        <entry>/json/policies?_action=evaluate, /json/policies?_evaluateTree</entry>
       </row>

       <row>
        <entry>N/A</entry>
        <entry>/json/dashboard</entry>
       </row>

       <row>
        <entry>N/A</entry>
        <entry>/json/policies</entry>
       </row>

       <row>
        <entry>N/A</entry>
        <entry>/json/serverinfo</entry>
       </row>
      </tbody>
     </tgroup>
    </table>

    <para>Find examples in the <citetitle>Developer Guide</citetitle> chapter on <link
     xlink:href="dev-guide#chap-rest" xlink:role="http://docbook.org/xlink/role/olink"
     xlink:show="new"><citetitle>Using RESTful Web Services</citetitle></link> in
     OpenAM.</para>

    <para>Support for the older REST services is likely to be removed in a
     future release in favor of the newer REST services. Older REST services
     will be removed only after replacement REST services are introduced.</para>
   </listitem>

  </itemizedlist>
 </section>

</chapter>
