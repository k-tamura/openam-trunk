<script  type="text/javascript">
    jQuery(function() {

        $("#ucontent").show();
        $("#done").hide();
        $('#donemy').show();
        $('#cancel').hide();
        $("#uprogress").hide();

        $("#upgradeButton").click(function(){
            doUpgrade();
        });

        function doUpgrade() {
            $("#setupMessage").text("");
            $("#ucontent").hide();
            $("#uprogress").show();
            disableClose();
            var fr1 = window.frames['progressIframe'];
            if ( fr1 ) {
                fr1.location = "$context/upgrade/setUpgradeProgress";
            }
            $.get("$context$path?actionLink=doUpgrade",
            function( data ) {
                if (data == 'true') {
                    $('#donemy').hide();
                    $('#done').show();
                    $('#prgrbrtle').replaceWith('<h3 class="message no-icon">$page.getLocalizedString("upgrade.option.complete.title")</h3>');
                    $('#prgrbr').replaceWith('<h3 class="message no-icon">$page.getLocalizedString("upgrade.option.complete.body")</h3>');
                } else {
                    $('#donemy').hide();
                    $('#done').hide();
                    $('#prgrbr').replaceWith('<h3 class="message no-icon">Configuration error</h3>');
                    $("#setupMessage").text(data);
                    $('#cancel').show();
                }
            });
        }

        $("#done").click(function(){
            upgradeCompleteDone();

        });

        $("#saveReportButton").click(function(){
            window.open("$context$path?actionLink=saveReport", "Download");
        });

        function disableClose() {
            $('#closeimg').removeAttr('href');
            $('#closeimg').removeAttr('onclick').click(function(e) { e.preventDefault(); });
        }

        $(document).keydown(function(e) {
            if (e.keyCode == 27) return false;
        });
        window.onbeforeunload = function(){
            return alert('$page.getLocalizedString("upgrade.restart.container")');
        };

    });
</script>
<div id="modal" class="box clear-float">
    <a id="closeimg" class="close" href="javascript:;" onclick="closeUpgradeConfig();">Close</a>
    <div class="col" id="left-col">
        <ol id="steps">
            <li class="on">Upgrade</li>
        </ol>
    </div>
    <div class="col left-seperator" id="main-col">
        <div id="ucontent">
            <h1>$page.getLocalizedString("upgrade.main.title")</h1>
            <h3 class="message no-icon">$page.getLocalizedString("upgrade.title")</h3>
            <p>$page.getLocalizedString("upgrade.description")</p>
            #if ($error)
            <fieldset>
                <legend>Details</legend>
                <p>$page.getLocalizedString("upgrade.init.error")</p>
            </fieldset>
            <div class="row">
                <button id="cancelButtonE" type="button" class="button primary" onclick="closeUpgradeConfig();">$page.getLocalizedString("cancel.button")</button>
            </div>
            #else
            <fieldset>
                <legend>Details</legend>
                <div style="margin: 10px 23px">
                    $page.getLocalizedString("upgrade.current.version") $currentVersion <br/>
                    $page.getLocalizedString("upgrade.new.version") $newVersion
                </div>
                <div style="overflow: auto; border: solid 1px; height: 180px; width: 90%; margin: 0 auto;">
                    $changelist
                </div>
            </fieldset>
            <div class="row">
                <button id="upgradeButton" type="button" class="button primary">$page.getLocalizedString("upgrade.button")</button>
                <input id="cancelButton" type="button" class="button" value='$page.getLocalizedString("cancel.button")' onclick="closeUpgradeConfig();"/>
                <button id="saveReportButton" type="button" class="button right">$page.getLocalizedString("save.report.button")</button>
            </div>
            #end
        </div>
        <div id="uprogress">
            <h1 id="prgrbrtle">Configuration Progress</h1>
            <h3 id="prgrbr" class="message no-icon"><img width="640" height="11" src="$context/images/loading.gif" /></h3>
            <fieldset>
                <legend>Details</legend>
                <iframe id="progressIframe" name="progressIframe" height=220 width=600 scrolling="no" frameborder="0">This browser cannot dipslay iframes.</iframe>
                <h4 id="setupMessage"></h4>
            </fieldset>
            <div class="row">
                <input type="submit" id="donemy" class="button disabled" value="Processing..."/>
                <input type="submit" id="done" class="button primary" value='$page.getLocalizedString("upgrade.restart.container")'/>
                <input type="button" id="cancel" class="button right" value="Close" onclick="closeUpgradeConfig();"/>
            </div>
        </div>
    </div>
</div>
